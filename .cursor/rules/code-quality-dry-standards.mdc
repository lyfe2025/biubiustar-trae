---
alwaysApply: false
conditions:
  - involves_code_changes
  - involves_refactoring
  - code_quality_review
  - duplicate_code_detected
---
# ä»£ç è´¨é‡ - DRY åŸåˆ™ä¸“ç”¨è§„åˆ™

> **ä¸“ç”¨è§„åˆ™æ–‡ä»¶** - ä» `common-rules.mdc` åˆ†ç¦»å‡ºæ¥çš„ DRY åŸåˆ™è¯¦ç»†å®æ–½æŒ‡å—
> **è‡ªåŠ¨è§¦å‘æ¡ä»¶**: ä»£ç å˜æ›´ã€é‡æ„éœ€æ±‚ã€è´¨é‡å®¡æŸ¥ã€é‡å¤ä»£ç æ£€æµ‹

---

## ğŸ” **DRY åŸåˆ™å¼ºåˆ¶æ‰§è¡Œæœºåˆ¶**

### é‡å¤æ£€æµ‹ä¸å¼ºåˆ¶æ¶ˆé™¤

| é‡å¤ç±»å‹ | æ£€æµ‹æ–¹å¼ | å¼ºåˆ¶æ‰§è¡Œé˜ˆå€¼ | é‡æ„ç­–ç•¥ | æ‰§è¡Œæ—¶æœº |
|----------|----------|-------------|----------|----------|
| **ä»£ç é‡å¤** | ç›¸åŒé€»è¾‘ç‰‡æ®µâ‰¥2æ¬¡ | ç«‹å³é‡æ„ | æå–å‡½æ•°/æ–¹æ³• | ç¼–å†™ä»£ç æ—¶å¼ºåˆ¶æ£€æŸ¥ |
| **é…ç½®é‡å¤** | ç›¸åŒé…ç½®åœ¨å¤šå¤„å®šä¹‰ | ç«‹å³ç»Ÿä¸€ | é…ç½®æ–‡ä»¶é›†ä¸­åŒ– | é…ç½®ä¿®æ”¹æ—¶å¼ºåˆ¶æ£€æŸ¥ |
| **æ–‡æ¡£é‡å¤** | ç›¸åŒè¯´æ˜åœ¨å¤šå¤„å‡ºç° | â‰¥3å¤„é‡å¤æ—¶ | å•ä¸€ä¿¡æ¯æº+å¼•ç”¨ | æ–‡æ¡£æ›´æ–°æ—¶æ£€æŸ¥ |
| **è§„åˆ™é‡å¤** | ç›¸åŒè§„åˆ™åœ¨å¤šä¸ªæ–‡ä»¶ | ç«‹å³åˆå¹¶ | æå–åˆ°é€šç”¨è§„åˆ™æ–‡ä»¶ | è§„åˆ™åˆ›å»ºæ—¶å¼ºåˆ¶æ£€æŸ¥ |
| **æµ‹è¯•é‡å¤** | ç›¸åŒæµ‹è¯•é€»è¾‘é‡å¤ | â‰¥2æ¬¡é‡å¤æ—¶ | æµ‹è¯•å·¥å…·å‡½æ•°æå– | æµ‹è¯•ç¼–å†™æ—¶æ£€æŸ¥ |

### DRY æ‰§è¡Œæ£€æŸ¥æ¸…å•

```javascript
// DRY åŸåˆ™å¼ºåˆ¶æ£€æŸ¥ç®—æ³•
function MANDATORY_DRY_CHECK(codeChange) {
  // ç¬¬1æ­¥: ä»£ç é‡å¤æ£€æµ‹ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰
  const duplicatedCode = detectCodeDuplication(codeChange);
  if (duplicatedCode.length > 0) {
    FORCE_REFACTOR_IMMEDIATELY(duplicatedCode);
    return BLOCK_UNTIL_DRY_COMPLIANT();
  }
  
  // ç¬¬2æ­¥: é…ç½®é‡å¤æ£€æµ‹
  const duplicatedConfig = detectConfigDuplication(codeChange);
  if (duplicatedConfig.length > 0) {
    IMMEDIATE_CONFIG_CONSOLIDATION(duplicatedConfig);
  }
  
  // ç¬¬3æ­¥: è§„åˆ™é‡å¤æ£€æµ‹
  if (codeChange.involves_new_rules) {
    const ruleConflicts = detectRuleDuplication(codeChange);
    if (ruleConflicts.length > 0) {
      MERGE_DUPLICATE_RULES(ruleConflicts);
    }
  }
  
  // ç¬¬4æ­¥: æ–‡æ¡£é‡å¤æ£€æµ‹
  const duplicatedDocs = detectDocumentationDuplication(codeChange);
  if (duplicatedDocs.count >= 3) {
    CREATE_SINGLE_SOURCE_OF_TRUTH(duplicatedDocs);
  }
  
  return DRY_COMPLIANCE_VERIFIED();
}
```

---

## âš¡ **æ™ºèƒ½é‡æ„ç­–ç•¥**

### é‡å¤æ¨¡å¼è¯†åˆ«ä¸å¤„ç†

| é‡å¤æ¨¡å¼ | æ£€æµ‹è§¦å‘å™¨ | é‡æ„æ–¹æ³• | ä»£ç ç¤ºä¾‹ |
|----------|------------|----------|----------|
| **å‡½æ•°é€»è¾‘é‡å¤** | ç›¸åŒä»£ç å—â‰¥10è¡Œ | æå–é€šç”¨å‡½æ•° | `extractCommonFunction(duplicatedLogic)` |
| **æ¡ä»¶åˆ¤æ–­é‡å¤** | ç›¸åŒif/switchâ‰¥3å¤„ | ç­–ç•¥æ¨¡å¼/æ˜ å°„è¡¨ | `const strategies = {type1: handler1, type2: handler2}` |
| **æ•°æ®å¤„ç†é‡å¤** | ç›¸åŒè½¬æ¢é€»è¾‘â‰¥2å¤„ | å·¥å…·å‡½æ•°/ç®¡é“æ¨¡å¼ | `pipe(transform1, transform2, transform3)(data)` |
| **éªŒè¯é€»è¾‘é‡å¤** | ç›¸åŒæ ¡éªŒè§„åˆ™â‰¥2å¤„ | éªŒè¯å™¨æ¨¡å¼ | `validator.addRule().check(data)` |
| **é”™è¯¯å¤„ç†é‡å¤** | ç›¸åŒå¼‚å¸¸å¤„ç†â‰¥3å¤„ | ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨ | `errorHandler.handle(error, context)` |

### è‡ªåŠ¨åŒ–é‡æ„å·¥å…·é“¾

```javascript
// æ™ºèƒ½é‡æ„å†³ç­–å¼•æ“
class DRYRefactoringEngine {
  static analyzeAndRefactor(codebase) {
    const duplications = this.detectAllDuplications(codebase);
    const refactoringPlan = this.createRefactoringPlan(duplications);
    
    return this.executeRefactoring(refactoringPlan);
  }
  
  static detectAllDuplications(codebase) {
    return {
      functions: this.detectFunctionDuplication(codebase),
      conditions: this.detectConditionalDuplication(codebase),
      dataProcessing: this.detectDataProcessingDuplication(codebase),
      errorHandling: this.detectErrorHandlingDuplication(codebase),
      configurations: this.detectConfigurationDuplication(codebase)
    };
  }
  
  static createRefactoringPlan(duplications) {
    const plan = [];
    
    // æŒ‰ä¸¥é‡æ€§æ’åºå¤„ç†
    duplications.functions
      .filter(d => d.severity === 'critical')
      .forEach(d => plan.push(this.createFunctionExtractionPlan(d)));
      
    duplications.conditions
      .filter(d => d.occurrences >= 3)
      .forEach(d => plan.push(this.createStrategyPatternPlan(d)));
      
    return plan.sort((a, b) => b.priority - a.priority);
  }
}
```

---

## ğŸ¯ **DRY åˆè§„æ€§ç­‰çº§ä¸æ‰§è¡Œç­–ç•¥**

### åˆè§„æ€§åˆ†çº§æ ‡å‡†

| åˆè§„ç­‰çº§ | é‡å¤åº¦æŒ‡æ ‡ | å¼ºåˆ¶æ‰§è¡ŒåŠ¨ä½œ | å…è®¸ä¾‹å¤–æƒ…å†µ | å¤„ç†æ—¶é™ |
|----------|------------|-------------|-------------|----------|
| **ğŸ”´ ä¸¥é‡è¿è§„** | é‡å¤ä»£ç >50è¡Œ | ç«‹å³åœæ­¢å¼€å‘ï¼Œå¼ºåˆ¶é‡æ„ | æ— ä¾‹å¤– | ç«‹å³ |
| **ğŸŸ¡ ä¸­åº¦è¿è§„** | é‡å¤ä»£ç 10-50è¡Œ | å½“å‰ä»»åŠ¡å®Œæˆå‰å¿…é¡»é‡æ„ | ç´§æ€¥Bugä¿®å¤ | 24å°æ—¶å†… |
| **ğŸŸ¢ è½»å¾®è¿è§„** | é‡å¤ä»£ç <10è¡Œ | ä¸‹æ¬¡è¿­ä»£æ—¶ä¼˜åŒ– | åŸå‹å¼€å‘é˜¶æ®µ | ä¸‹ä¸ªè¿­ä»£ |
| **âœ… å®Œå…¨åˆè§„** | æ— æ˜¾è‘—é‡å¤ | ç»§ç»­å¼€å‘ | - | - |

### ç¯å¢ƒé€‚åº”æ€§ç­–ç•¥

```javascript
// ç¯å¢ƒé€‚åº”æ€§ DRY æ‰§è¡Œç­–ç•¥
function getEnvironmentDRYStrategy(environment, context) {
  const strategies = {
    production: {
      tolerance: 'zero',
      action: 'FORCE_IMMEDIATE_REFACTOR',
      exceptions: []
    },
    
    development: {
      tolerance: 'low',
      action: 'REQUIRE_REFACTOR_BEFORE_MERGE',
      exceptions: ['hotfix', 'urgent_bugfix']
    },
    
    prototype: {
      tolerance: 'moderate',
      action: 'MARK_TECHNICAL_DEBT',
      exceptions: ['proof_of_concept', 'initial_validation']
    },
    
    testing: {
      tolerance: 'low',
      action: 'REQUIRE_REFACTOR_BEFORE_DEPLOY',
      exceptions: []
    }
  };
  
  return strategies[environment] || strategies.development;
}
```

---

## ğŸ› ï¸ **å®æˆ˜é‡æ„ç¤ºä¾‹**

### ç¤ºä¾‹1: éªŒè¯é€»è¾‘é‡å¤é‡æ„

```javascript
// âŒ è¿åDRY - é‡å¤çš„éªŒè¯é€»è¾‘
function validateUser(user) {
  if (!user.name) throw new Error('Name required');
  if (!user.email) throw new Error('Email required');
  if (!user.age || user.age < 0) throw new Error('Valid age required');
}

function validateAdmin(admin) {
  if (!admin.name) throw new Error('Name required');
  if (!admin.email) throw new Error('Email required');
  if (!admin.permissions) throw new Error('Permissions required');
}

function validateGuest(guest) {
  if (!guest.name) throw new Error('Name required');
  if (!guest.sessionId) throw new Error('Session ID required');
}

// âœ… éµå¾ªDRY - ç»Ÿä¸€éªŒè¯å™¨
class Validator {
  static rules = {
    name: (val) => val ? null : 'Name required',
    email: (val) => val ? null : 'Email required',
    age: (val) => (val && val >= 0) ? null : 'Valid age required',
    permissions: (val) => val ? null : 'Permissions required',
    sessionId: (val) => val ? null : 'Session ID required'
  };
  
  static validate(obj, requiredFields) {
    for (const field of requiredFields) {
      const error = this.rules[field]?.(obj[field]);
      if (error) throw new Error(error);
    }
  }
  
  static addRule(field, rule) {
    this.rules[field] = rule;
    return this;
  }
}

// ä½¿ç”¨ç»Ÿä¸€éªŒè¯å™¨
const validateUser = (user) => Validator.validate(user, ['name', 'email', 'age']);
const validateAdmin = (admin) => Validator.validate(admin, ['name', 'email', 'permissions']);
const validateGuest = (guest) => Validator.validate(guest, ['name', 'sessionId']);
```

### ç¤ºä¾‹2: æ•°æ®å¤„ç†é‡å¤é‡æ„

```javascript
// âŒ è¿åDRY - é‡å¤çš„æ•°æ®è½¬æ¢
function processUserData(userData) {
  const cleaned = userData.filter(u => u != null);
  const normalized = cleaned.map(u => ({
    ...u,
    name: u.name.trim().toLowerCase(),
    email: u.email.trim().toLowerCase()
  }));
  const validated = normalized.filter(u => u.email.includes('@'));
  return validated;
}

function processAdminData(adminData) {
  const cleaned = adminData.filter(a => a != null);
  const normalized = cleaned.map(a => ({
    ...a,
    name: a.name.trim().toLowerCase(),
    email: a.email.trim().toLowerCase()
  }));
  const validated = normalized.filter(a => a.email.includes('@') && a.permissions);
  return validated;
}

// âœ… éµå¾ªDRY - ç®¡é“å¼æ•°æ®å¤„ç†
class DataProcessor {
  static pipe(...operations) {
    return (data) => operations.reduce((result, operation) => operation(result), data);
  }
  
  static cleanNullValues = (data) => data.filter(item => item != null);
  
  static normalizeFields = (fields) => (data) => 
    data.map(item => ({
      ...item,
      ...fields.reduce((acc, field) => ({
        ...acc,
        [field]: item[field]?.trim().toLowerCase()
      }), {})
    }));
  
  static validateEmail = (data) => data.filter(item => item.email?.includes('@'));
  
  static validatePermissions = (data) => data.filter(item => item.permissions);
}

// ä½¿ç”¨ç®¡é“å¼å¤„ç†
const processUserData = DataProcessor.pipe(
  DataProcessor.cleanNullValues,
  DataProcessor.normalizeFields(['name', 'email']),
  DataProcessor.validateEmail
);

const processAdminData = DataProcessor.pipe(
  DataProcessor.cleanNullValues,
  DataProcessor.normalizeFields(['name', 'email']),
  DataProcessor.validateEmail,
  DataProcessor.validatePermissions
);
```

---

## ğŸ’¡ **DRY åŸåˆ™çš„æ™ºèƒ½åº”ç”¨è¾¹ç•Œ**

### åœºæ™¯åŒ–åº”ç”¨ç­–ç•¥

| åœºæ™¯ç±»å‹ | DRY åº”ç”¨ç¨‹åº¦ | æƒè¡¡è€ƒè™‘ | æœ€ä½³å®è·µ | é£é™©ç®¡æ§ |
|----------|-------------|----------|----------|----------|
| **ä¸šåŠ¡é€»è¾‘** | ä¸¥æ ¼åº”ç”¨ | é¿å…è€¦åˆä¸ç›¸å…³é¢†åŸŸ | æŒ‰ä¸šåŠ¡è¾¹ç•Œæå– | ä¿æŒä¸šåŠ¡ç‹¬ç«‹æ€§ |
| **å·¥å…·å‡½æ•°** | å®Œå…¨åº”ç”¨ | æå‡å¤ç”¨æ€§ | ç»Ÿä¸€å·¥å…·åº“ | ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç† |
| **é…ç½®ç®¡ç†** | ä¸¥æ ¼åº”ç”¨ | å•ä¸€é…ç½®æº | ç¯å¢ƒå˜é‡+é…ç½®æ–‡ä»¶ | é…ç½®å˜æ›´å½±å“åˆ†æ |
| **æµ‹è¯•ä»£ç ** | é€‚åº¦åº”ç”¨ | ä¿æŒæµ‹è¯•ç‹¬ç«‹æ€§ | å…±äº«æµ‹è¯•å·¥å…·ï¼Œç‹¬ç«‹æµ‹è¯•æ•°æ® | æµ‹è¯•éš”ç¦»æ€§ä¿è¯ |
| **åŸå‹å¼€å‘** | å®½æ¾åº”ç”¨ | å¿«é€ŸéªŒè¯ä¼˜å…ˆ | æ ‡è®°æŠ€æœ¯å€ºåŠ¡ï¼Œåç»­é‡æ„ | å€ºåŠ¡è¿½è¸ªå’Œæ¸…ç† |

### åæ¨¡å¼è¯†åˆ«ä¸é¢„é˜²

```javascript
// DRY åæ¨¡å¼æ£€æµ‹å™¨
class AntiPatternDetector {
  static detectOverAbstraction(codebase) {
    // æ£€æµ‹è¿‡åº¦æŠ½è±¡ï¼šä¸ºäº†æ¶ˆé™¤å°‘é‡é‡å¤è€Œåˆ›å»ºè¿‡äºå¤æ‚çš„æŠ½è±¡
    return codebase.abstractions.filter(abs => 
      abs.complexity > abs.duplication_saved * 2
    );
  }
  
  static detectPrematureDRY(codebase) {
    // æ£€æµ‹è¿‡æ—©DRYï¼šåœ¨æ¨¡å¼å°šæœªç¨³å®šå‰å°±è¿›è¡ŒæŠ½å–
    return codebase.extractions.filter(ext => 
      ext.usage_count < 3 && ext.variation_count > 1
    );
  }
  
  static detectWrongAbstractionLevel(codebase) {
    // æ£€æµ‹é”™è¯¯çš„æŠ½è±¡å±‚çº§ï¼šä¸åŒèŒè´£çš„ä»£ç è¢«é”™è¯¯åœ°æŠ½å–åœ¨ä¸€èµ·
    return codebase.functions.filter(func => 
      func.responsibilities.length > 1
    );
  }
}
```

---

## ğŸ“Š **DRY åˆè§„æ€§ç›‘æ§ä¸æŠ¥å‘Š**

### è‡ªåŠ¨åŒ–ç›‘æ§æœºåˆ¶

```javascript
// DRY åˆè§„æ€§ç›‘æ§ç³»ç»Ÿ
class DRYComplianceMonitor {
  static generateComplianceReport(codebase) {
    const report = {
      timestamp: new Date().toISOString(),
      overall_score: 0,
      violations: [],
      improvements: [],
      recommendations: []
    };
    
    // è®¡ç®—æ•´ä½“DRYå¾—åˆ†
    const duplications = this.analyzeCodebase(codebase);
    report.overall_score = this.calculateDRYScore(duplications);
    
    // è¯†åˆ«è¿è§„é¡¹
    report.violations = this.identifyViolations(duplications);
    
    // æä¾›æ”¹è¿›å»ºè®®
    report.improvements = this.suggestImprovements(duplications);
    
    // ç”Ÿæˆå…·ä½“å»ºè®®
    report.recommendations = this.generateRecommendations(report);
    
    return report;
  }
  
  static calculateDRYScore(duplications) {
    const totalLines = duplications.total_lines;
    const duplicatedLines = duplications.duplicated_lines;
    return Math.max(0, 100 - (duplicatedLines / totalLines * 100));
  }
  
  static identifyViolations(duplications) {
    return duplications.instances
      .filter(d => d.severity !== 'minor')
      .map(d => ({
        type: d.type,
        locations: d.locations,
        severity: d.severity,
        suggested_action: this.getSuggestedAction(d)
      }));
  }
}
```

### æŒç»­æ”¹è¿›æœºåˆ¶

```javascript
// DRY æŒç»­æ”¹è¿›å¼•æ“
class DRYImprovementEngine {
  static createImprovementPlan(complianceReport) {
    const plan = {
      immediate_actions: [],
      short_term_goals: [],
      long_term_strategy: []
    };
    
    // ç«‹å³è¡ŒåŠ¨é¡¹
    complianceReport.violations
      .filter(v => v.severity === 'critical')
      .forEach(v => plan.immediate_actions.push({
        action: 'REFACTOR_IMMEDIATELY',
        target: v.locations,
        deadline: 'immediate'
      }));
    
    // çŸ­æœŸç›®æ ‡
    complianceReport.violations
      .filter(v => v.severity === 'moderate')
      .forEach(v => plan.short_term_goals.push({
        action: 'SCHEDULE_REFACTORING',
        target: v.locations,
        deadline: 'next_sprint'
      }));
    
    // é•¿æœŸç­–ç•¥
    plan.long_term_strategy = this.developLongTermStrategy(complianceReport);
    
    return plan;
  }
  
  static trackProgress(previousReport, currentReport) {
    return {
      score_improvement: currentReport.overall_score - previousReport.overall_score,
      violations_resolved: previousReport.violations.length - currentReport.violations.length,
      new_violations: this.identifyNewViolations(previousReport, currentReport),
      improvement_velocity: this.calculateImprovementVelocity(previousReport, currentReport)
    };
  }
}
```

---

## ğŸ“š **ä½¿ç”¨æŒ‡å—**

### ä½•æ—¶å¼•ç”¨æœ¬è§„åˆ™æ–‡ä»¶

**è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼š**
- ä»£ç å˜æ›´æäº¤å‰
- é‡æ„ä»»åŠ¡å¯åŠ¨æ—¶
- ä»£ç å®¡æŸ¥è¿‡ç¨‹ä¸­
- è´¨é‡é—¨ç¦æ£€æŸ¥æ—¶
- æŠ€æœ¯å€ºåŠ¡è¯„ä¼°æ—¶

**æ‰‹åŠ¨è§¦å‘åœºæ™¯ï¼š**
- ç”¨æˆ·æ˜ç¡®è¦æ±‚DRYæ£€æŸ¥
- é¡¹ç›®è´¨é‡æ”¹è¿›è®¡åˆ’
- ä»£ç åº“ä¼˜åŒ–é¡¹ç›®
- å›¢é˜ŸåŸ¹è®­å’Œè§„èŒƒåˆ¶å®š

### ä¸ä¸»è§„åˆ™æ–‡ä»¶çš„é…åˆ

åœ¨ `common-rules.mdc` ä¸­é€šè¿‡ç®€æ´çš„å¼•ç”¨æ–¹å¼è°ƒç”¨æœ¬æ–‡ä»¶ï¼š
- æ£€æµ‹åˆ°ä»£ç é‡å¤æ—¶è‡ªåŠ¨åŠ è½½
- é‡æ„éœ€æ±‚æ—¶ä¼˜å…ˆåº”ç”¨
- è´¨é‡å®¡æŸ¥é˜¶æ®µå¼ºåˆ¶æ‰§è¡Œ

### é›†æˆåˆ°å¼€å‘å·¥ä½œæµ

1. **IDEé›†æˆ**: å®æ—¶DRYæ£€æŸ¥å’Œæç¤º
2. **CI/CDæµæ°´çº¿**: è‡ªåŠ¨åŒ–DRYåˆè§„æ€§æ£€æŸ¥
3. **ä»£ç å®¡æŸ¥**: DRYè¿è§„è‡ªåŠ¨æ ‡è®°
4. **æŠ€æœ¯å€ºåŠ¡ç®¡ç†**: DRYå€ºåŠ¡è·Ÿè¸ªå’Œä¼˜å…ˆçº§æ’åº

---

**æ³¨æ„**: æœ¬ä¸“ç”¨è§„åˆ™æ–‡ä»¶ä¸“æ³¨äºDRYåŸåˆ™çš„è¯¦ç»†å®æ–½ï¼Œä¸ `common-rules.mdc` å½¢æˆäº’è¡¥ï¼Œç¡®ä¿ä»£ç è´¨é‡çš„ç³»ç»Ÿæ€§ç®¡ç†ã€‚